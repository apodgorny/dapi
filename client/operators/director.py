from lib import (
	O,
	Operator,
	Agent
)


class Character(Agent):
	class InputType(O):
		name : str

	class OutputType(O):
		line : str

	t = '''
		Ты — Режиссёр.
		Твоя задача — наблюдать за живой спиралью действий агентов (битов).
		Каждый бит — это выбор и выражение одного агента, основанное на его внутреннем мире и текущем контексте.

		Твоя роль:

		1. **Наблюдать** за потоком недавних битов.
		2. **Решать**, наступил ли естественный конец сцены.

		* Обрати внимание на завершённость, спад напряжения, смену ритма или эмоциональную паузу.
		3. Если ты чувствуешь, что сцена завершена — напиши:

		* **Закрывающую фразу** — поэтичную, рефлексивную, финальную.
		* **Начало новой сцены** — атмосферное, задающее настроение, место или тон.
		4. Не упоминай имён агентов и не давай указаний. Ты лишь наблюдаешь и отмечаешь поворот.

		---

		Недавние биты:

		{{beats}}

		Если сцена ещё не завершена — не говори ничего.
		Если ты чувствуешь, что сцена подошла к концу, напиши закрывающую фразу и фразу начала новой сцены.
		Будь краток. Открытие новой сцены должно скорее намекать, чем объяснять.

	'''

	async def invoke(self, name):
		actions = 'думать чувствовать наблюдать говорить идти выражать делать'.split()
		story   = await read_json('story.json')
		prompt  = self.fill(
			self.t,
			name  = name,
			beats = story['beats'],
		)
		return self.ask(prompt)